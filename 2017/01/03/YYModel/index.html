<!DOCTYPE html>
<html lang="zh-CN">
<head>

    <!--[if lt IE 9]>
        <style>body {display: none; background: none !important} </style>
        <meta http-equiv="Refresh" Content="0; url=//outdatedbrowser.com/" />
    <![endif]-->

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="format-detection" content="telephone=no" />
<meta name="author" content="Chen Ao" />



<meta name="description" content="前言YYModel 是一个iOS JSON模型转化库，和其他一些同类型库相比，具有比较好的性能优势。本文会对YYModel的源码进行分析，具体用法作者ibireme在github中有提及。YYModel的目录结构很简单，只有两个类, NSObject+YYModel 和 YYClassInfo。YYClassInfo主要对根类NSObject 的 Ivar , Method, Property以及">
<meta property="og:type" content="article">
<meta property="og:title" content="YYModel源码分析">
<meta property="og:url" content="http://ChenAo0727.github.io/2017/01/03/YYModel/index.html">
<meta property="og:site_name" content="夜空中最亮的星">
<meta property="og:description" content="前言YYModel 是一个iOS JSON模型转化库，和其他一些同类型库相比，具有比较好的性能优势。本文会对YYModel的源码进行分析，具体用法作者ibireme在github中有提及。YYModel的目录结构很简单，只有两个类, NSObject+YYModel 和 YYClassInfo。YYClassInfo主要对根类NSObject 的 Ivar , Method, Property以及">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/1618300-fd7b658a12d7bcee.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:updated_time" content="2017-01-04T07:23:41.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="YYModel源码分析">
<meta name="twitter:description" content="前言YYModel 是一个iOS JSON模型转化库，和其他一些同类型库相比，具有比较好的性能优势。本文会对YYModel的源码进行分析，具体用法作者ibireme在github中有提及。YYModel的目录结构很简单，只有两个类, NSObject+YYModel 和 YYClassInfo。YYClassInfo主要对根类NSObject 的 Ivar , Method, Property以及">
<meta name="twitter:image" content="http://upload-images.jianshu.io/upload_images/1618300-fd7b658a12d7bcee.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">

<link rel="apple-touch-icon" href= "/apple-touch-icon.png">


    <link rel="alternate" href="/atom.xml" title="夜空中最亮的星" type="application/atom+xml">



    <link rel="shortcut icon" href="/img/Coding.png">



    <link href="//cdn.bootcss.com/animate.css/3.5.1/animate.min.css" rel="stylesheet">



    <link href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet">



    <script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
    <link href="//cdn.bootcss.com/pace/1.0.2/themes/blue/pace-theme-minimal.css" rel="stylesheet">


<link rel="stylesheet" href="/css/style.css">



<link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">


<title>YYModel源码分析 | 夜空中最亮的星</title>

<script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
<script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>

<script>
    var yiliaConfig = {
        fancybox: true,
        animate: true,
        isHome: false,
        isPost: true,
        isArchive: false,
        isTag: false,
        isCategory: false,
        fancybox_js: "//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js",
        scrollreveal: "//cdn.bootcss.com/scrollReveal.js/3.1.4/scrollreveal.min.js",
        search: true
    }
</script>


    <script> yiliaConfig.jquery_ui = [false]; </script>



    <script> yiliaConfig.rootUrl = "\/";</script>






</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            <img src="/img/bg.png" class="animated zoomIn">
        </a>
        <hgroup>
          <h1 class="header-author"><a href="/">Chen Ao</a></h1>
        </hgroup>

        
        <p class="header-subtitle">生于忧患，死于安乐</p>
        

        
            <form id="search-form">
            <input type="text" id="local-search-input" name="q" placeholder="search..." class="search form-control" autocomplete="off" autocorrect="off" searchonload="false" />
            <i class="fa fa-times" onclick="resetSearch()"></i>
            </form>
            <div id="local-search-result"></div>
            <p class='no-result'>No results found <i class='fa fa-spinner fa-pulse'></i></p>
        


        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜單</li>
                        <li>標籤</li>
                        
                        <li>友情鏈接</li>
                        
                        
                        <li>關於我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/">主页</a></li>
                        
                            <li><a href="/archives/">所有文章</a></li>
                        
                            <li><a href="/tags/">标签云</a></li>
                        
                            <li><a href="/about/">关于我</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" href="mailto:jim735410965@126.com" title="Email"></a>
                            
                                <a class="fa 新浪微博" href="http://weibo.com/u/1773408564" title="新浪微博"></a>
                            
                                <a class="fa GitHub" href="https://github.com/ChenAo0727" title="GitHub"></a>
                            
                                <a class="fa 简书" href="http://www.jianshu.com/users/872519599961/latest_articles" title="简书"></a>
                            
                                <a class="fa RSS" href="/atom.xml" title="RSS"></a>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hexo/">Hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OC/">OC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/swift/">swift</a></li></ul>
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a class="main-nav-link switch-friends-link" href="https://hexo.io">Hexo</a>
                    
                      <a class="main-nav-link switch-friends-link" href="https://pages.github.com/">GitHub</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://moxfive.xyz/">MOxFIVE</a>
                    
                    </div>
                </section>
                

                
                
                <section class="switch-part switch-part4">
                
                    <div id="js-aboutme">iOS Coder</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">Chen Ao</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                <img src="/img/bg.png" class="animated zoomIn">
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页">Chen Ao</a></h1>
            </hgroup>
            
            <p class="header-subtitle">生于忧患，死于安乐</p>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">主页</a></li>
                
                    <li><a href="/archives/">所有文章</a></li>
                
                    <li><a href="/tags/">标签云</a></li>
                
                    <li><a href="/about/">关于我</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" target="_blank" href="mailto:jim735410965@126.com" title="Email"></a>
                            
                                <a class="fa 新浪微博" target="_blank" href="http://weibo.com/u/1773408564" title="新浪微博"></a>
                            
                                <a class="fa GitHub" target="_blank" href="https://github.com/ChenAo0727" title="GitHub"></a>
                            
                                <a class="fa 简书" target="_blank" href="http://www.jianshu.com/users/872519599961/latest_articles" title="简书"></a>
                            
                                <a class="fa RSS" target="_blank" href="/atom.xml" title="RSS"></a>
                            
                        </ul>
            </nav>
        </header>                
    </div>
    <link class="menu-list" tags="標籤" friends="友情鏈接" about="關於我"/>
</nav>
      <div class="body-wrap"><article id="post-YYModel" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/01/03/YYModel/" class="article-date">
      <time datetime="2017-01-03T01:43:35.000Z" itemprop="datePublished">2017-01-03</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      YYModel源码分析
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/术业专攻/">术业专攻</a>
    </div>


        
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/OC/">OC</a></li></ul>
    </div>

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>YYModel 是一个iOS JSON模型转化库，和其他一些同类型库相比，具有比较好的性能优势。本文会对YYModel的源码进行分析，具体用法作者ibireme在<a href="https://github.com/ibireme/YYModel" target="_blank" rel="external">github</a>中有提及。YYModel的目录结构很简单，只有两个类, <code>NSObject+YYModel</code> 和 <code>YYClassInfo</code>。<code>YYClassInfo</code>主要对根类NSObject 的 <code>Ivar</code> , <code>Method</code>, <code>Property</code>以及<code>Class</code>本身进行了封装，<code>NSObject+YYModel</code> 是 NSObject的分类，扩展了一些JSON模型转化的方法。 <a id="more"></a></p>
<h2 id="YYClassInfo"><a href="#YYClassInfo" class="headerlink" title="YYClassInfo"></a>YYClassInfo</h2><h3 id="要点"><a href="#要点" class="headerlink" title="要点"></a>要点</h3><blockquote>
<p> YYClassIvarInfo : 对 Class的Ivar进行了封装<br> YYClassMethodInfo : 对 Class的Method进行了封装<br> YYClassPropertyInfo :  对 Class的Property进行了封装<br> YYClassInfo :  对Class进行了封装，包含了YYClassIvarInfo，YYClassMethodInfo，YYClassPropertyInfo</p>
</blockquote>
<h3 id="变量类型编码"><a href="#变量类型编码" class="headerlink" title="变量类型编码"></a>变量类型编码</h3><p>说到变量，可能我们写代码中最常见的就是变量了。当我们自定义一个类时，首先总是会申明一些属性，而且每个属性都会带有一些修饰词。比如是否原子性，内存管理原则，只读性。这些都可以通过这个属性的<code>property_getAttributes</code> 方法获取，苹果为所有的类型，包括属性类型都有编码，具体可以查看<a href="https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Articles/ocrtTypeEncodings.html" target="_blank" rel="external">苹果官方文档:类型编码</a>, <a href="https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Articles/ocrtPropertyIntrospection.html" target="_blank" rel="external">苹果官方文档:属性类型</a>。 下面是一个简单例子：</p>
<ol>
<li>申明属性</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">@interface Cat : NSObject</div><div class="line">@end</div><div class="line"></div><div class="line">@interface Person : NSObject</div><div class="line">@property (nonatomic,copy) NSString *name;</div><div class="line">@property (nonatomic,assign) NSInteger age;</div><div class="line">@property (nonatomic,strong) Cat *cat;</div><div class="line">- (NSDictionary *)getProperties;</div><div class="line">@end</div></pre></td></tr></table></figure>
<p>2.通过runtime 来获取所有属性</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">#import &quot;Person.h&quot;</div><div class="line">#import &lt;objc/runtime.h&gt;</div><div class="line">@implementation Person</div><div class="line">- (NSDictionary *) getProperties&#123;</div><div class="line">    NSMutableDictionary *dic = [NSMutableDictionary dictionary];</div><div class="line">    unsigned int count = 0;</div><div class="line">    objc_property_t *propertyList = class_copyPropertyList([self class], &amp;count);</div><div class="line">    for (NSUInteger  i = 0; i &lt; count; i++) &#123;</div><div class="line">        const char *name = property_getName(propertyList[i]);</div><div class="line">        const char *attribute = property_getAttributes(propertyList[i]);</div><div class="line">        NSString *nameStr = [NSString stringWithUTF8String:name];</div><div class="line">        NSString *attributeStr = [NSString stringWithUTF8String:attribute];</div><div class="line">        dic[nameStr] = attributeStr;</div><div class="line">    &#125;</div><div class="line">    return [dic copy];</div><div class="line">&#125;</div><div class="line"></div><div class="line">@end</div></pre></td></tr></table></figure>
<p>3.打印结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">2017-01-03 10:54:34.690 Properties[16941:881462] &#123;</div><div class="line">    age = &quot;Tq,N,V_age&quot;;</div><div class="line">    cat = &quot;T@\&quot;Cat\&quot;,&amp;,N,V_cat&quot;;</div><div class="line">    name = &quot;T@\&quot;NSString\&quot;,C,N,V_name&quot;;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们可以看到属性的所有类型编码信息，其中第一个代表是这个变量的类型，以T开头，最后一个代表的是变量的名字，一般用V_属性名表示，中间的部分就是我们声明的修饰符。比如age的类型是 Tq，而在官方文档中q 代表了<code>A long long</code>,64bit下NSInteger的取值范围就是long == long long ，N代表了非原子性，变量名是_age。其他的@代表了OC类型 <code>id</code> ,cat类型即是T@”Cat”，&amp;代表了 这个变量是retain （ARC下strong相当于retain），C 代表了copy</p>
<h3 id="YYEncodingType"><a href="#YYEncodingType" class="headerlink" title="YYEncodingType"></a>YYEncodingType</h3><p>根据类型编码自定义了类型枚举，包含了三个部分</p>
<blockquote>
<p>YYEncodingTypeMask : 0~8位的值，变量的数据类型<br>YYEncodingTypeQualifierMask : 8~16位的值，变量的方法类型<br>YYEncodingTypePropertyMask: 16~24位的值，变量的属性类型</p>
</blockquote>
<p>这里把枚举值分成三个部分，通过 枚举值 &amp;  对应 Mask 取出对应的变量类型，区分不同类型部分。<code>YYEncodingGetType</code> 是根据变量的数据类型编码值获取自定义<code>YYEncodingType</code></p>
<h3 id="Var-Method-Property"><a href="#Var-Method-Property" class="headerlink" title="Var Method Property"></a>Var Method Property</h3><blockquote>
<p>YYClassIvarInfo：用于存取变量的信息</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> Instance variable information.</div><div class="line"> */</div><div class="line">@interface YYClassIvarInfo : NSObject</div><div class="line">@property (nonatomic, assign, readonly) Ivar ivar;              ///&lt; ivar opaque struct</div><div class="line">@property (nonatomic, strong, readonly) NSString *name;         ///&lt; Ivar&apos;s name</div><div class="line">@property (nonatomic, assign, readonly) ptrdiff_t offset;       ///&lt; Ivar&apos;s offset</div><div class="line">@property (nonatomic, strong, readonly) NSString *typeEncoding; ///&lt; Ivar&apos;s type encoding</div><div class="line">@property (nonatomic, assign, readonly) YYEncodingType type;    ///&lt; Ivar&apos;s type</div><div class="line"></div><div class="line">/**</div><div class="line"> Creates and returns an ivar info object.</div><div class="line"> </div><div class="line"> @param ivar ivar opaque struct</div><div class="line"> @return A new object, or nil if an error occurs.</div><div class="line"> */</div><div class="line">- (instancetype)initWithIvar:(Ivar)ivar;</div><div class="line">@end</div></pre></td></tr></table></figure>
<p>Ivar是表示实例变量的类型，其实际是一个指向objc_ivar结构体的指针，其定义如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">struct objc_ivar &#123;  </div><div class="line">    charchar *ivar_name                              OBJC2_UNAVAILABLE;  </div><div class="line">    charchar *ivar_type                              OBJC2_UNAVAILABLE;  </div><div class="line">    int ivar_offset                                  OBJC2_UNAVAILABLE;  </div><div class="line">#ifdef __LP64__  </div><div class="line">    int space                                        OBJC2_UNAVAILABLE;  </div><div class="line">#endif  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p> 运用runtime,<code>name</code>通过的<code>ivar_getName</code>获取，<code>offset</code>  通过<code>ivar_getOffset</code>获取，<code>typeEncoding</code> 通过 <code>ivar_getTypeEncoding</code> 获取，<code>type</code> 通过自定义方法 <code>YYEncodingGetType</code>获取。其中<code>offset</code>是变量的基地址偏移量，可以通过它来直接访问变量数据,下面是例子：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">    Person *p = [[Person alloc]init];</div><div class="line">//    NSLog(@&quot;%@&quot;,[p getProperties]);</div><div class="line">    p.age = 20;</div><div class="line">    Ivar age_ivar = class_getInstanceVariable([Person class], &quot;_age&quot;);</div><div class="line">    long *age_pointer = (long *)((__bridge void  *)(p) + ivar_getOffset(age_ivar));</div><div class="line">    NSLog(@&quot;age ivar offset = %td&quot;, ivar_getOffset(age_ivar));</div><div class="line">    *age_pointer = 10;</div><div class="line">    NSLog(@&quot;%@&quot;, p);</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">- (NSString *)description &#123;</div><div class="line">    NSLog(@&quot;current pointer = %p&quot;, self);</div><div class="line">    NSLog(@&quot;age pointer = %p&quot;, &amp;_age);</div><div class="line">    return [NSString stringWithFormat:@&quot;age = %zi&quot;, _age];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>打印结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">2017-01-03 14:41:14.175 Properties[20934:1554728] age ivar offset = 16</div><div class="line">2017-01-03 14:41:14.176 Properties[20934:1554728] current pointer = 0x600000075140</div><div class="line">2017-01-03 14:41:14.176 Properties[20934:1554728] age pointer = 0x600000075150</div><div class="line">2017-01-03 14:41:14.177 Properties[20934:1554728] age = 10</div></pre></td></tr></table></figure>
<blockquote>
<p>YYClassMethodInfo：用于存取方法的信息</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> Method information.</div><div class="line"> */</div><div class="line">@interface YYClassMethodInfo : NSObject</div><div class="line">@property (nonatomic, assign, readonly) Method method;                  ///&lt; method opaque struct</div><div class="line">@property (nonatomic, strong, readonly) NSString *name;                 ///&lt; method name</div><div class="line">@property (nonatomic, assign, readonly) SEL sel;                        ///&lt; method&apos;s selector</div><div class="line">@property (nonatomic, assign, readonly) IMP imp;                        ///&lt; method&apos;s implementation</div><div class="line">@property (nonatomic, strong, readonly) NSString *typeEncoding;         ///&lt; method&apos;s parameter and return types</div><div class="line">@property (nonatomic, strong, readonly) NSString *returnTypeEncoding;   ///&lt; return value&apos;s type</div><div class="line">@property (nullable, nonatomic, strong, readonly) NSArray&lt;NSString *&gt; *argumentTypeEncodings; ///&lt; array of arguments&apos; type</div><div class="line"></div><div class="line">/**</div><div class="line"> Creates and returns a method info object.</div><div class="line"> </div><div class="line"> @param method method opaque struct</div><div class="line"> @return A new object, or nil if an error occurs.</div><div class="line"> */</div><div class="line">- (instancetype)initWithMethod:(Method)method;</div><div class="line">@end</div></pre></td></tr></table></figure>
<p><code>Method</code> 的信息同 <code>Ivar</code> 一样，通过runtime的 method相关方法获取，其他的一些信息同<code>Ivar</code>，主要来说一下 <code>SEL</code>和 <code>Imp</code></p>
<blockquote>
<p>SEL: 方法ID，C字符串</p>
</blockquote>
<p><code>typedef struct objc_selector *SEL;</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">/// Defines a method</div><div class="line">struct objc_method_description &#123;</div><div class="line">	SEL name;               /**&lt; The name of the method */</div><div class="line">	char *types;            /**&lt; The types of the method arguments */</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<blockquote>
<p>IMP：方法函数指针 </p>
</blockquote>
<p>OC是动态语言，方法调用（也叫做消息发送）是在运行时动态绑定的，而非编译时。如何做到正确的调用指定的方法呢？这里就需要用到SEL和IMP。编译器会将消息发送转换成对<code>objc_msgSend(void /* id self, SEL op, ... */ )</code>方法的调用 。<code>objc_msgSend</code>方法根据对象的isa指针找到对象的类，通过在类中的调度表（dispatch table）中查找SEL 获得 IMP,精确执行指定方法。</p>
<blockquote>
<p>YYClassPropertyInfo: 用于存取属性的信息</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> Property information.</div><div class="line"> */</div><div class="line">@interface YYClassPropertyInfo : NSObject</div><div class="line">@property (nonatomic, assign, readonly) objc_property_t property; ///&lt; property&apos;s opaque struct</div><div class="line">@property (nonatomic, strong, readonly) NSString *name;           ///&lt; property&apos;s name</div><div class="line">@property (nonatomic, assign, readonly) YYEncodingType type;      ///&lt; property&apos;s type</div><div class="line">@property (nonatomic, strong, readonly) NSString *typeEncoding;   ///&lt; property&apos;s encoding value</div><div class="line">@property (nonatomic, strong, readonly) NSString *ivarName;       ///&lt; property&apos;s ivar name</div><div class="line">@property (nullable, nonatomic, assign, readonly) Class cls;      ///&lt; may be nil</div><div class="line">@property (nullable, nonatomic, strong, readonly) NSArray&lt;NSString *&gt; *protocols; ///&lt; may nil</div><div class="line">@property (nonatomic, assign, readonly) SEL getter;               ///&lt; getter (nonnull)</div><div class="line">@property (nonatomic, assign, readonly) SEL setter;               ///&lt; setter (nonnull)</div><div class="line"></div><div class="line">/**</div><div class="line"> Creates and returns a property info object.</div><div class="line"> </div><div class="line"> @param property property opaque struct</div><div class="line"> @return A new object, or nil if an error occurs.</div><div class="line"> */</div><div class="line">- (instancetype)initWithProperty:(objc_property_t)property;</div><div class="line">@end</div></pre></td></tr></table></figure>
<blockquote>
<p>YYClassInfo: 对Class的封装，包含了上面三部分的信息</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> Class information for a class.</div><div class="line"> */</div><div class="line">@interface YYClassInfo : NSObject</div><div class="line">@property (nonatomic, assign, readonly) Class cls; ///&lt; class object</div><div class="line">@property (nullable, nonatomic, assign, readonly) Class superCls; ///&lt; super class object</div><div class="line">@property (nullable, nonatomic, assign, readonly) Class metaCls;  ///&lt; class&apos;s meta class object</div><div class="line">@property (nonatomic, readonly) BOOL isMeta; ///&lt; whether this class is meta class</div><div class="line">@property (nonatomic, strong, readonly) NSString *name; ///&lt; class name</div><div class="line">@property (nullable, nonatomic, strong, readonly) YYClassInfo *superClassInfo; ///&lt; super class&apos;s class info</div><div class="line">@property (nullable, nonatomic, strong, readonly) NSDictionary&lt;NSString *, YYClassIvarInfo *&gt; *ivarInfos; ///&lt; ivars</div><div class="line">@property (nullable, nonatomic, strong, readonly) NSDictionary&lt;NSString *, YYClassMethodInfo *&gt; *methodInfos; ///&lt; methods</div><div class="line">@property (nullable, nonatomic, strong, readonly) NSDictionary&lt;NSString *, YYClassPropertyInfo *&gt; *propertyInfos; ///&lt; properties</div></pre></td></tr></table></figure>
<h3 id="元类"><a href="#元类" class="headerlink" title="元类"></a>元类</h3><p>其中有<code>metaCls</code>代表了元类。那什么是元类呢？下面是一张经典的类结构图</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1618300-fd7b658a12d7bcee.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="isa.png"></p>
<p>在OC中，每个实例对象都有一个isa指针，它指向了对象的class。而这个class也同样有一个isa指针，它就是指向了它的元类，其实类也是一个对象，所以对象之于类的关系，就相当于类（类对象）之于其元类（类对象的类）的关系。那元类有什么用呢？我们都知道在OC中调用方法有实例方法和类方法。我们调用实例方法，就是通过isa指针找到指定的class，查找存储在class中的方法列表执行方法，所以元类的作用就是调用类方法时，通过查找保存在元类中的类方法执行方法的作用。那为什么不把所有方法都保存在类中，可能这样更加高效也节省资源吧，具体可以自己查找资料。</p>
<p>在YYClassInfo中，有一个<code>_update</code>方法，用来更新类中存储的信息。</p>
<h3 id="初始化方法"><a href="#初始化方法" class="headerlink" title="初始化方法"></a>初始化方法</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">+ (instancetype)classInfoWithClass:(Class)cls &#123;</div><div class="line">    if (!cls) return nil;</div><div class="line">    static CFMutableDictionaryRef classCache;</div><div class="line">    static CFMutableDictionaryRef metaCache;</div><div class="line">    static dispatch_once_t onceToken;</div><div class="line">    static dispatch_semaphore_t lock;</div><div class="line">    dispatch_once(&amp;onceToken, ^&#123;</div><div class="line">        classCache = CFDictionaryCreateMutable(CFAllocatorGetDefault(), 0, &amp;kCFTypeDictionaryKeyCallBacks, &amp;kCFTypeDictionaryValueCallBacks);</div><div class="line">        metaCache = CFDictionaryCreateMutable(CFAllocatorGetDefault(), 0, &amp;kCFTypeDictionaryKeyCallBacks, &amp;kCFTypeDictionaryValueCallBacks);</div><div class="line">        lock = dispatch_semaphore_create(1);</div><div class="line">    &#125;);</div><div class="line">    dispatch_semaphore_wait(lock, DISPATCH_TIME_FOREVER);</div><div class="line">    YYClassInfo *info = CFDictionaryGetValue(class_isMetaClass(cls) ? metaCache : classCache, (__bridge const void *)(cls));</div><div class="line">    if (info &amp;&amp; info-&gt;_needUpdate) &#123;</div><div class="line">        [info _update];</div><div class="line">    &#125;</div><div class="line">    dispatch_semaphore_signal(lock);</div><div class="line">    if (!info) &#123;</div><div class="line">        info = [[YYClassInfo alloc] initWithClass:cls];</div><div class="line">        if (info) &#123;</div><div class="line">            dispatch_semaphore_wait(lock, DISPATCH_TIME_FOREVER);</div><div class="line">            CFDictionarySetValue(info.isMeta ? metaCache : classCache, (__bridge const void *)(cls), (__bridge const void *)(info));</div><div class="line">            dispatch_semaphore_signal(lock);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    return info;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>要点:</strong></p>
<ul>
<li><p>CFDictionaryCreateMutable 和  CFDictionarySetValue 不是线程安全的，所以需要创建锁，采用 <code>dispatch_semaphore</code> 通过控制信号量实现了锁</p>
</li>
<li><p>设置缓存，如果在缓存中存在class，则直接获取到对应的ivar，method，property，否者创建YYClassInfo实例对象</p>
</li>
</ul>
<h2 id="NSObject-YYModel"><a href="#NSObject-YYModel" class="headerlink" title="NSObject+YYModel:"></a>NSObject+YYModel:</h2><p><code>NSObject+YYModel</code>是YYModel的核心类，主要部分：</p>
<blockquote>
<p>强制内联C函数：功能函数<br>私有类_YYModelPropertyMeta : 管理Model属性的数据, 类型, 映射的key，keyPath<br>私有类 _YYModelMeta :管理Model 数据,类型,存储 映射key,keypath，_YYModelPropertyMeta<br>NSObject NSArray NSDictionary (YYModel) : 几个分类，YYModel主体功能实现<br>YYModel 协议：扩展功能实现</p>
</blockquote>
<h3 id="私有类-YYModelPropertyMeta"><a href="#私有类-YYModelPropertyMeta" class="headerlink" title="私有类_YYModelPropertyMeta"></a>私有类_YYModelPropertyMeta</h3><p><code>_YYModelPropertyMeta</code>是对上面的 <code>YYClassPropertyInfo</code> 的进一步封装。</p>
<h4 id="内部实例变量"><a href="#内部实例变量" class="headerlink" title="内部实例变量"></a>内部实例变量</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">/// A property info in object model.</div><div class="line">// model property的进一步分装</div><div class="line">@interface _YYModelPropertyMeta : NSObject &#123;</div><div class="line">    @package</div><div class="line">    NSString *_name;              //属性名</div><div class="line">    YYEncodingType _type;         //属性的编码类型</div><div class="line">    YYEncodingNSType _nsType;     //属性的Foundation类型</div><div class="line">    BOOL _isCNumber;              //是否c语言的数字</div><div class="line">    Class _cls;                   //属性的class</div><div class="line">    Class _genericCls;    //属性内包含的类class</div><div class="line">    SEL _getter;             //属性 getter方法</div><div class="line">    SEL _setter;             //属性 setter方法</div><div class="line">    BOOL _isKVCCompatible;     //是否可以使用KVC</div><div class="line">    BOOL _isStructAvailableForKeyedArchiver;   //是否struct并且可以归档</div><div class="line">    BOOL _hasCustomClassFromDictionary;   //是否包含本本地的class转换</div><div class="line">    /*</div><div class="line">     property-&gt;key:     </div><div class="line">   _mappedToKey:key   _mappedToKeyPath:nil   _mappedToKeyArray:nil</div><div class="line">     property-&gt;keyPath:  </div><div class="line">   _mappedToKey:keyPath _mappedToKeyPath:keyPath(array)  _mappedToKeyArray:nil</div><div class="line">     property-&gt;keys:   </div><div class="line">   _mappedToKey:keys[0] _mappedToKeyPath:nil/keyPath        _mappedToKeyArray:keys(array)</div><div class="line">     */</div><div class="line">    NSString *_mappedToKey;     //属性名映射的 key </div><div class="line">    NSArray *_mappedToKeyPath;  //属性名映射的 keyPath </div><div class="line">    NSArray *_mappedToKeyArray;  //属性名的映射的key keyPath 数组 </div><div class="line">    YYClassPropertyInfo *_info;  //属性的YYClassPropertyInfo info</div><div class="line">    _YYModelPropertyMeta *_next;  </div><div class="line">    //多个属性名映射到同一个key 时，指向下一个属性名的YYModelPropertyMeta 指针</div><div class="line">&#125;</div><div class="line">@end</div></pre></td></tr></table></figure>
<p>主要是最后几个变量。其中<code>_mappedToKey</code> <code>_mappedToKeyPath</code> <code>_mappedToKeyArray</code> 是属性映射的key，keyPath ，key (keypath) 数组<code>_mappedToKeyArray</code> 中可以是key和keyPath，实际取其中第一个映射到的值</p>
<p>一般一个属性名对应一个key值，如果多个属性名对应同一个key，这里就需要next发挥作用了。比如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    @&quot;name1&quot; : @&quot;name&quot;,</div><div class="line">    @&quot;name2&quot; : @&quot;name&quot;,</div><div class="line">    @&quot;name3&quot; : @&quot;name&quot;,</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>首先name1最先得到映射，对mapKey进行赋值，取得json中的name字段进行赋值一系列操作，此时next指针为nil<br>name2接着进行映射，对mapKey进行赋值，接着取得原来json key对应的属性描述对象，将name2的next指针，指向name1。<br>name3接着进行映射，对mapKey进行赋值，接着取得原来json key对应的属性描述对象，将name3的next指针，指向name2。</p>
<p><strong>代码中的实现</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">propertyMeta-&gt;_next = mapper[mappedToKey] ?: nil;</div><div class="line">mapper[mappedToKey] = propertyMeta;</div></pre></td></tr></table></figure>
<h4 id="初始化方法-1"><a href="#初始化方法-1" class="headerlink" title="初始化方法"></a>初始化方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div></pre></td><td class="code"><pre><div class="line">@implementation _YYModelPropertyMeta</div><div class="line">+ (instancetype)metaWithClassInfo:(YYClassInfo *)classInfo propertyInfo:(YYClassPropertyInfo *)propertyInfo generic:(Class)generic &#123;</div><div class="line">    //创建并且根据propertyInfo 进行变量赋值</div><div class="line">    _YYModelPropertyMeta *meta = [self new];</div><div class="line">    meta-&gt;_name = propertyInfo.name;</div><div class="line">    meta-&gt;_type = propertyInfo.type;</div><div class="line">    meta-&gt;_info = propertyInfo;</div><div class="line"></div><div class="line">    // 属性为容器类型的时候， 映射类型赋值</div><div class="line">    meta-&gt;_genericCls = generic;</div><div class="line"></div><div class="line">    if ((meta-&gt;_type &amp; YYEncodingTypeMask) == YYEncodingTypeObject) &#123; </div><div class="line">         // 是否Foundation 类型</div><div class="line">        meta-&gt;_nsType = YYClassGetNSType(propertyInfo.cls);</div><div class="line">    &#125; else &#123; </div><div class="line">        // 是否C数据类型</div><div class="line">        meta-&gt;_isCNumber = YYEncodingTypeIsCNumber(meta-&gt;_type);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // 属性为结构体类型</div><div class="line">    if ((meta-&gt;_type &amp; YYEncodingTypeMask) == YYEncodingTypeStruct) &#123;</div><div class="line">        /*</div><div class="line">         It seems that NSKeyedUnarchiver cannot decode NSValue except these structs:</div><div class="line">         */</div><div class="line">        static NSSet *types = nil;</div><div class="line">        static dispatch_once_t onceToken;</div><div class="line">        // 单例 创建C结构体类型映射</div><div class="line">        dispatch_once(&amp;onceToken, ^&#123;</div><div class="line">            NSMutableSet *set = [NSMutableSet new];</div><div class="line">            // 32 bit</div><div class="line">            [set addObject:@&quot;&#123;CGSize=ff&#125;&quot;];</div><div class="line">            [set addObject:@&quot;&#123;CGPoint=ff&#125;&quot;];</div><div class="line">            [set addObject:@&quot;&#123;CGRect=&#123;CGPoint=ff&#125;&#123;CGSize=ff&#125;&#125;&quot;];</div><div class="line">            [set addObject:@&quot;&#123;CGAffineTransform=ffffff&#125;&quot;];</div><div class="line">            [set addObject:@&quot;&#123;UIEdgeInsets=ffff&#125;&quot;];</div><div class="line">            [set addObject:@&quot;&#123;UIOffset=ff&#125;&quot;];</div><div class="line">            // 64 bit</div><div class="line">            [set addObject:@&quot;&#123;CGSize=dd&#125;&quot;];</div><div class="line">            [set addObject:@&quot;&#123;CGPoint=dd&#125;&quot;];</div><div class="line">            [set addObject:@&quot;&#123;CGRect=&#123;CGPoint=dd&#125;&#123;CGSize=dd&#125;&#125;&quot;];</div><div class="line">            [set addObject:@&quot;&#123;CGAffineTransform=dddddd&#125;&quot;];</div><div class="line">            [set addObject:@&quot;&#123;UIEdgeInsets=dddd&#125;&quot;];</div><div class="line">            [set addObject:@&quot;&#123;UIOffset=dd&#125;&quot;];</div><div class="line">            types = set;</div><div class="line">        &#125;);</div><div class="line"></div><div class="line">        // 只有上面结构体才能被归档</div><div class="line">        if ([types containsObject:propertyInfo.typeEncoding]) &#123;</div><div class="line">            meta-&gt;_isStructAvailableForKeyedArchiver = YES;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    // 设置class类型</div><div class="line">    meta-&gt;_cls = propertyInfo.cls;</div><div class="line"></div><div class="line">    // 如果是容器类型</div><div class="line">    if (generic) &#123;</div><div class="line">        // 从容器class 中读取</div><div class="line">        meta-&gt;_hasCustomClassFromDictionary = [generic respondsToSelector:@selector(modelCustomClassForDictionary:)];</div><div class="line">    &#125; else if (meta-&gt;_cls &amp;&amp; meta-&gt;_nsType == YYEncodingTypeNSUnknown) &#123;</div><div class="line">        // 从class类型中读取</div><div class="line">        meta-&gt;_hasCustomClassFromDictionary = [meta-&gt;_cls respondsToSelector:@selector(modelCustomClassForDictionary:)];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // 设置 getter 和 setter 方法</div><div class="line">    if (propertyInfo.getter) &#123;</div><div class="line">        if ([classInfo.cls instancesRespondToSelector:propertyInfo.getter]) &#123;</div><div class="line">            meta-&gt;_getter = propertyInfo.getter;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    if (propertyInfo.setter) &#123;</div><div class="line">        if ([classInfo.cls instancesRespondToSelector:propertyInfo.setter]) &#123;</div><div class="line">            meta-&gt;_setter = propertyInfo.setter;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /**</div><div class="line">     *  只有实现了getter和setter方法 才能实现归档</div><div class="line">     */</div><div class="line">    if (meta-&gt;_getter &amp;&amp; meta-&gt;_setter) &#123;</div><div class="line">        /*</div><div class="line">        类型是否支持 KVC</div><div class="line">         */</div><div class="line">        switch (meta-&gt;_type &amp; YYEncodingTypeMask) &#123;</div><div class="line">            case YYEncodingTypeBool:</div><div class="line">            case YYEncodingTypeInt8:</div><div class="line">            case YYEncodingTypeUInt8:</div><div class="line">            case YYEncodingTypeInt16:</div><div class="line">            case YYEncodingTypeUInt16:</div><div class="line">            case YYEncodingTypeInt32:</div><div class="line">            case YYEncodingTypeUInt32:</div><div class="line">            case YYEncodingTypeInt64:</div><div class="line">            case YYEncodingTypeUInt64:</div><div class="line">            case YYEncodingTypeFloat:</div><div class="line">            case YYEncodingTypeDouble:</div><div class="line">            case YYEncodingTypeObject:</div><div class="line">            case YYEncodingTypeClass:</div><div class="line">            case YYEncodingTypeBlock:</div><div class="line">            case YYEncodingTypeStruct:</div><div class="line">            case YYEncodingTypeUnion: &#123;</div><div class="line">                meta-&gt;_isKVCCompatible = YES;</div><div class="line">            &#125; break;</div><div class="line">            default: break;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    return meta;</div><div class="line">&#125;</div><div class="line">@end</div></pre></td></tr></table></figure>
<h3 id="私有类-YYModelMeta"><a href="#私有类-YYModelMeta" class="headerlink" title="私有类_YYModelMeta"></a>私有类_YYModelMeta</h3><p><code>_YYModelMeta</code> 是对 <code>YYClassInfo</code> 的再次封装</p>
<h4 id="内部变量"><a href="#内部变量" class="headerlink" title="内部变量"></a>内部变量</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">@interface _YYModelMeta : NSObject &#123;</div><div class="line">    @package</div><div class="line">    YYClassInfo *_classInfo;</div><div class="line"></div><div class="line">    // key: 映射的 json key ,keyPath  value： _YYModelPropertyMeta </div><div class="line">    NSDictionary *_mapper;</div><div class="line"></div><div class="line">    // model所有属性的PropertyMetas</div><div class="line">    NSArray *_allPropertyMetas;</div><div class="line"></div><div class="line">    //model所有映射son keyPath 属性 的PropertyMetas</div><div class="line">    NSArray *_keyPathPropertyMetas;</div><div class="line"></div><div class="line">    // model所有映射多个key 属性 的PropertyMetas</div><div class="line">    NSArray *_multiKeysPropertyMetas;</div><div class="line">    /// 需要映射的属性总个数</div><div class="line">    NSUInteger _keyMappedCount;</div><div class="line"></div><div class="line">    /// Model对应的Foundation 类型</div><div class="line">    YYEncodingNSType _nsType;</div><div class="line"></div><div class="line">    // 事否实现了自定义的映射关系表 </div><div class="line">    BOOL _hasCustomWillTransformFromDictionary;</div><div class="line">    BOOL _hasCustomTransformFromDictionary;</div><div class="line">    BOOL _hasCustomTransformToDictionary;</div><div class="line">    BOOL _hasCustomClassFromDictionary;</div><div class="line">&#125;</div><div class="line">@end</div></pre></td></tr></table></figure>
<h4 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">/// Returns the cached model class meta</div><div class="line">+ (instancetype)metaWithClass:(Class)cls &#123;</div><div class="line">    if (!cls) return nil;</div><div class="line">    static CFMutableDictionaryRef cache;</div><div class="line">    static dispatch_once_t onceToken;</div><div class="line">    static dispatch_semaphore_t lock;</div><div class="line">    dispatch_once(&amp;onceToken, ^&#123;</div><div class="line">        cache = CFDictionaryCreateMutable(CFAllocatorGetDefault(), 0, &amp;kCFTypeDictionaryKeyCallBacks, &amp;kCFTypeDictionaryValueCallBacks);</div><div class="line">        lock = dispatch_semaphore_create(1);</div><div class="line">    &#125;);</div><div class="line">    dispatch_semaphore_wait(lock, DISPATCH_TIME_FOREVER);</div><div class="line">    _YYModelMeta *meta = CFDictionaryGetValue(cache, (__bridge const void *)(cls));</div><div class="line">    dispatch_semaphore_signal(lock);</div><div class="line">    if (!meta || meta-&gt;_classInfo.needUpdate) &#123;</div><div class="line">        meta = [[_YYModelMeta alloc] initWithClass:cls];</div><div class="line">        if (meta) &#123;</div><div class="line">            dispatch_semaphore_wait(lock, DISPATCH_TIME_FOREVER);</div><div class="line">            CFDictionarySetValue(cache, (__bridge const void *)(cls), (__bridge const void *)(meta));</div><div class="line">            dispatch_semaphore_signal(lock);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    return meta;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>首先从缓存中加载，没有在根据传入cls 创建meta，并做缓存处理， dispatch_semaphore 确保线程安全</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div></pre></td><td class="code"><pre><div class="line">@implementation _YYModelMeta</div><div class="line"></div><div class="line"></div><div class="line">- (instancetype)initWithClass:(Class)cls &#123;</div><div class="line"></div><div class="line">    YYClassInfo *classInfo = [YYClassInfo classInfoWithClass:cls];</div><div class="line">    if (!classInfo) return nil;</div><div class="line">    self = [super init];</div><div class="line"></div><div class="line">    // 黑名单 会忽略返回数组里的属性</div><div class="line">    NSSet *blacklist = nil;</div><div class="line">    if ([cls respondsToSelector:@selector(modelPropertyBlacklist)]) &#123;</div><div class="line">        NSArray *properties = [(id&lt;YYModel&gt;)cls modelPropertyBlacklist];</div><div class="line">        if (properties) &#123;</div><div class="line">            blacklist = [NSSet setWithArray:properties];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // 白名单 只考虑返回数组内的属性 </div><div class="line">    NSSet *whitelist = nil;</div><div class="line">    if ([cls respondsToSelector:@selector(modelPropertyWhitelist)]) &#123;</div><div class="line">        NSArray *properties = [(id&lt;YYModel&gt;)cls modelPropertyWhitelist];</div><div class="line">        if (properties) &#123;</div><div class="line">            whitelist = [NSSet setWithArray:properties];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // 获取容器属性中的映射关系字典</div><div class="line">    NSDictionary *genericMapper = nil;</div><div class="line">   // 判断类中是否实现了对应的modelContainerPropertyGenericClass方法</div><div class="line">    if ([cls respondsToSelector:@selector(modelContainerPropertyGenericClass)]) &#123;</div><div class="line"></div><div class="line">        genericMapper = [(id&lt;YYModel&gt;)cls modelContainerPropertyGenericClass];</div><div class="line">      // 存储key和对应的class到字典中</div><div class="line">        if (genericMapper) &#123;</div><div class="line">            NSMutableDictionary *tmp = [NSMutableDictionary new];</div><div class="line">            [genericMapper enumerateKeysAndObjectsUsingBlock:^(id key, id obj, BOOL *stop) &#123;</div><div class="line">                if (![key isKindOfClass:[NSString class]]) return;</div><div class="line">                Class meta = object_getClass(obj);</div><div class="line">                if (!meta) return;</div><div class="line">                if (class_isMetaClass(meta)) &#123;</div><div class="line">                    tmp[key] = obj;</div><div class="line">                &#125; else if ([obj isKindOfClass:[NSString class]]) &#123;</div><div class="line">                    Class cls = NSClassFromString(obj);</div><div class="line">                    if (cls) &#123;</div><div class="line">                        tmp[key] = cls;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;];</div><div class="line">            genericMapper = tmp;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // 存储所有属性的PropertyMeta对象</div><div class="line"></div><div class="line">    NSMutableDictionary *allPropertyMetas = [NSMutableDictionary new];</div><div class="line">    YYClassInfo *curClassInfo = classInfo;</div><div class="line">    while (curClassInfo &amp;&amp; curClassInfo.superCls != nil) &#123; // recursive parse super class, but ignore root class (NSObject/NSProxy)</div><div class="line">        // 遍历当前ClassInfo 中的所有PropertyInfo， 将它们封装成PropertyMeta</div><div class="line">        for (YYClassPropertyInfo *propertyInfo in curClassInfo.propertyInfos.allValues) &#123;</div><div class="line">            // 检查是否合法和黑白名单筛选</div><div class="line">            if (!propertyInfo.name) continue;</div><div class="line">            if (blacklist &amp;&amp; [blacklist containsObject:propertyInfo.name]) continue;</div><div class="line">            if (whitelist &amp;&amp; ![whitelist containsObject:propertyInfo.name]) continue;</div><div class="line"></div><div class="line">            // 通过propetyInfo来创建PropertyMeta 对象</div><div class="line">            _YYModelPropertyMeta *meta = [_YYModelPropertyMeta metaWithClassInfo:classInfo</div><div class="line">                                                                    propertyInfo:propertyInfo</div><div class="line">                                                                         generic:genericMapper[propertyInfo.name]];</div><div class="line">            // meta name非空</div><div class="line">            if (!meta || !meta-&gt;_name) continue;</div><div class="line">            // 需要实现get方法和set方法</div><div class="line">            if (!meta-&gt;_getter || !meta-&gt;_setter) continue;</div><div class="line">            // 字典中已有该字段的meta 避免重复操作</div><div class="line">            if (allPropertyMetas[meta-&gt;_name]) continue;</div><div class="line">            allPropertyMetas[meta-&gt;_name] = meta;</div><div class="line">        &#125;</div><div class="line">        // 遍历父类的property</div><div class="line">        curClassInfo = curClassInfo.superClassInfo;</div><div class="line">    &#125;</div><div class="line">  </div><div class="line">    if (allPropertyMetas.count)</div><div class="line">  _allPropertyMetas = allPropertyMetas.allValues.copy;</div><div class="line"></div><div class="line">    // 创建 key ：propertyMeta 映射关系字典</div><div class="line">    NSMutableDictionary *mapper = [NSMutableDictionary new];</div><div class="line">    NSMutableArray *keyPathPropertyMetas = [NSMutableArray new];</div><div class="line">    NSMutableArray *multiKeysPropertyMetas = [NSMutableArray new];</div><div class="line"></div><div class="line">    // 是否实现自定义的映射表</div><div class="line">    if ([cls respondsToSelector:@selector(modelCustomPropertyMapper)]) &#123;</div><div class="line">        </div><div class="line">        NSDictionary *customMapper = [(id &lt;YYModel&gt;)cls modelCustomPropertyMapper];</div><div class="line"></div><div class="line">        // 遍历自定义的字典</div><div class="line">        [customMapper enumerateKeysAndObjectsUsingBlock:^(NSString *propertyName, NSString *mappedToKey, BOOL *stop) &#123;</div><div class="line">           </div><div class="line">            _YYModelPropertyMeta *propertyMeta = allPropertyMetas[propertyName];</div><div class="line">            if (!propertyMeta) return;</div><div class="line">            // 由于用户自定义映射，把原来映射的数据删除</div><div class="line">            [allPropertyMetas removeObjectForKey:propertyName];</div><div class="line"></div><div class="line">            if ([mappedToKey isKindOfClass:[NSString class]]) &#123; </div><div class="line">               // key字段非空</div><div class="line">                if (mappedToKey.length == 0) return;</div><div class="line">                // 保存映射的key</div><div class="line">                propertyMeta-&gt;_mappedToKey = mappedToKey;</div><div class="line"></div><div class="line">                // 如果是keyPath的情况处理</div><div class="line">                NSArray *keyPath = [mappedToKey componentsSeparatedByString:@&quot;.&quot;];</div><div class="line"></div><div class="line">                if (keyPath.count &gt; 1) &#123;  </div><div class="line">                    propertyMeta-&gt;_mappedToKeyPath = keyPath;</div><div class="line">                    [keyPathPropertyMetas addObject:propertyMeta];</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                // 多个属性映射同一个key的时候，用next存储前一个 json Key映射的meta</div><div class="line">                propertyMeta-&gt;_next = mapper[mappedToKey] ?: nil;</div><div class="line">                // 保存新的meta对象</div><div class="line">                mapper[mappedToKey] = propertyMeta;</div><div class="line"></div><div class="line">            &#125; else if ([mappedToKey isKindOfClass:[NSArray class]]) &#123; </div><div class="line"></div><div class="line">         // 一个属性映射多个json Key</div><div class="line"></div><div class="line">                NSMutableArray *mappedToKeyArray = [NSMutableArray new];</div><div class="line">                for (NSString *oneKey in ((NSArray *)mappedToKey)) &#123;</div><div class="line">                    if (![oneKey isKindOfClass:[NSString class]]) continue;</div><div class="line">                    if (oneKey.length == 0) continue;</div><div class="line"></div><div class="line">                    NSArray *keyPath = [oneKey componentsSeparatedByString:@&quot;.&quot;];</div><div class="line">                    if (keyPath.count &gt; 1) &#123;</div><div class="line">                        [mappedToKeyArray addObject:keyPath];</div><div class="line">                    &#125; else &#123;</div><div class="line">                        [mappedToKeyArray addObject:oneKey];</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    if (!propertyMeta-&gt;_mappedToKey) &#123;</div><div class="line">                        propertyMeta-&gt;_mappedToKey = oneKey;</div><div class="line">                        propertyMeta-&gt;_mappedToKeyPath = keyPath.count &gt; 1 ? keyPath : nil;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                if (!propertyMeta-&gt;_mappedToKey) return;</div><div class="line"></div><div class="line">                propertyMeta-&gt;_mappedToKeyArray = mappedToKeyArray;</div><div class="line">                [multiKeysPropertyMetas addObject:propertyMeta];</div><div class="line"></div><div class="line">                propertyMeta-&gt;_next = mapper[mappedToKey] ?: nil;</div><div class="line">                mapper[mappedToKey] = propertyMeta;</div><div class="line">            &#125;</div><div class="line">        &#125;];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // 没有自定义映射规则的属性处理</div><div class="line"></div><div class="line">    [allPropertyMetas enumerateKeysAndObjectsUsingBlock:^(NSString *name, _YYModelPropertyMeta *propertyMeta, BOOL *stop) &#123;</div><div class="line">        // 直接让mappedKey等于属性名</div><div class="line">        propertyMeta-&gt;_mappedToKey = name;</div><div class="line">        propertyMeta-&gt;_next = mapper[name] ?: nil;</div><div class="line">        mapper[name] = propertyMeta;</div><div class="line">    &#125;];</div><div class="line"></div><div class="line">    // 变量存储</div><div class="line">    if (mapper.count) _mapper = mapper;</div><div class="line">    if (keyPathPropertyMetas) _keyPathPropertyMetas = keyPathPropertyMetas;</div><div class="line">    if (multiKeysPropertyMetas) _multiKeysPropertyMetas = multiKeysPropertyMetas;</div><div class="line"></div><div class="line">    _classInfo = classInfo;</div><div class="line">    _keyMappedCount = _allPropertyMetas.count;</div><div class="line">    _nsType = YYClassGetNSType(cls);</div><div class="line">    _hasCustomWillTransformFromDictionary = ([cls instancesRespondToSelector:@selector(modelCustomWillTransformFromDictionary:)]);</div><div class="line">    _hasCustomTransformFromDictionary = ([cls instancesRespondToSelector:@selector(modelCustomTransformFromDictionary:)]);</div><div class="line">    _hasCustomTransformToDictionary = ([cls instancesRespondToSelector:@selector(modelCustomTransformToDictionary:)]);</div><div class="line">    _hasCustomClassFromDictionary = ([cls respondsToSelector:@selector(modelCustomClassForDictionary:)]);</div><div class="line">    return self;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="JSON-转-Model"><a href="#JSON-转-Model" class="headerlink" title="JSON 转 Model"></a>JSON 转 Model</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">+ (instancetype)yy_modelWithJSON:(id)son &#123;</div><div class="line">    NSDictionary *dic = [self _yy_dictionaryWithJSON:json];</div><div class="line">    return [self yy_modelWithDictionary:dic];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>传入的json可以是 <code>NSDictionary</code>, <code>NSString</code> , <code>NSData</code>，<code>_yy_dictionaryWithJSON</code> 统一转化成字典</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">+ (instancetype)yy_modelWithDictionary:(NSDictionary *)dictionary &#123;</div><div class="line">    //字典合法性校验</div><div class="line">    if (!dictionary || dictionary == (id)kCFNull) return nil;</div><div class="line">    if (![dictionary isKindOfClass:[NSDictionary class]]) return nil;</div><div class="line">    </div><div class="line">    Class cls = [self class];</div><div class="line">   //创建 model 元数据</div><div class="line">    _YYModelMeta *modelMeta = [_YYModelMeta metaWithClass:cls];</div><div class="line">   //自定义字典</div><div class="line">    if (modelMeta-&gt;_hasCustomClassFromDictionary) &#123;</div><div class="line">        cls = [cls modelCustomClassForDictionary:dictionary] ?: cls;</div><div class="line">    &#125;</div><div class="line">    // 根据dictionary 进行 model 属性赋值</div><div class="line">    NSObject *one = [cls new];</div><div class="line">    if ([one yy_modelSetWithDictionary:dictionary]) return one;</div><div class="line">    return nil;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>结构体 <code>ModelSetContext</code> 存储 modelMeta ，model， dic 作为 <code>CFDictionaryApplyFunction</code> 和 <code>CFArrayApplyFunction</code> 的context 参数，传递数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line">- (BOOL)yy_modelSetWithDictionary:(NSDictionary *)dic &#123;</div><div class="line"></div><div class="line">   // 合法性检验</div><div class="line">    if (!dic || dic == (id)kCFNull) return NO;</div><div class="line">    if (![dic isKindOfClass:[NSDictionary class]]) return NO;</div><div class="line">    </div><div class="line"></div><div class="line">    _YYModelMeta *modelMeta = [_YYModelMeta metaWithClass:object_getClass(self)];</div><div class="line">    if (modelMeta-&gt;_keyMappedCount == 0) return NO;</div><div class="line">    </div><div class="line">    if (modelMeta-&gt;_hasCustomWillTransformFromDictionary) &#123;</div><div class="line">        dic = [((id&lt;YYModel&gt;)self) modelCustomWillTransformFromDictionary:dic];</div><div class="line">        if (![dic isKindOfClass:[NSDictionary class]]) return NO;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    ModelSetContext context = &#123;0&#125;;</div><div class="line">    context.modelMeta = (__bridge void *)(modelMeta);</div><div class="line">    context.model = (__bridge void *)(self);</div><div class="line">    context.dictionary = (__bridge void *)(dic);</div><div class="line">   </div><div class="line">    if (modelMeta-&gt;_keyMappedCount &gt;= CFDictionaryGetCount((CFDictionaryRef)dic)) &#123;</div><div class="line">        //映射的key Count &gt;= dic Count</div><div class="line">        CFDictionaryApplyFunction((CFDictionaryRef)dic, ModelSetWithDictionaryFunction, &amp;context);</div><div class="line">        if (modelMeta-&gt;_keyPathPropertyMetas) &#123;</div><div class="line">            CFArrayApplyFunction((CFArrayRef)modelMeta-&gt;_keyPathPropertyMetas,</div><div class="line">                                 CFRangeMake(0, CFArrayGetCount((CFArrayRef)modelMeta-&gt;_keyPathPropertyMetas)),</div><div class="line">                                 ModelSetWithPropertyMetaArrayFunction,</div><div class="line">                                 &amp;context);</div><div class="line">        &#125;</div><div class="line">        if (modelMeta-&gt;_multiKeysPropertyMetas) &#123;</div><div class="line">            CFArrayApplyFunction((CFArrayRef)modelMeta-&gt;_multiKeysPropertyMetas,</div><div class="line">                                 CFRangeMake(0, CFArrayGetCount((CFArrayRef)modelMeta-&gt;_multiKeysPropertyMetas)),</div><div class="line">                                 ModelSetWithPropertyMetaArrayFunction,</div><div class="line">                                 &amp;context);</div><div class="line">        &#125;</div><div class="line">    &#125; else &#123;</div><div class="line">         //映射的key Count &lt; dic Count  </div><div class="line">        CFArrayApplyFunction((CFArrayRef)modelMeta-&gt;_allPropertyMetas,</div><div class="line">                             CFRangeMake(0, modelMeta-&gt;_keyMappedCount),</div><div class="line">                             ModelSetWithPropertyMetaArrayFunction,</div><div class="line">                             &amp;context);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    if (modelMeta-&gt;_hasCustomTransformFromDictionary) &#123;</div><div class="line">        return [((id&lt;YYModel&gt;)self) modelCustomTransformFromDictionary:dic];</div><div class="line">    &#125;</div><div class="line">    return YES;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>   调用CoreFoundation 的   CFDictionaryApplyFunction 和  CFArrayApplyFunction 回调自定义的 Apply function<br><code>static void ModelSetWithDictionaryFunction(const void *_key, const void *_value, void *_context)</code> 和 <code>static void ModelSetWithPropertyMetaArrayFunction(const void *_propertyMeta, void *_context)</code></p>
<p>根据获得的value ，model ，_propertyMeta 最后统一调用 下面方法，运用runtime的 <code>objc_msgSend</code> 设置model属性</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">static void ModelSetValueForProperty(__unsafe_unretained id model,</div><div class="line">                                     __unsafe_unretained id value,</div><div class="line">                                     __unsafe_unretained _YYModelPropertyMeta *meta)</div></pre></td></tr></table></figure>
<p>自定义的<code>CFDictionaryApplyFunction</code> 的回调方法，CoreFoundation中的原回调函数<br><code>typedef void (*CFDictionaryApplierFunction)(const void *key, const void *value, void *context);</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> Apply function for dictionary, to set the key-value pair to model.</div><div class="line"> </div><div class="line"> @param _key     should not be nil, NSString.</div><div class="line"> @param _value   should not be nil.</div><div class="line"> @param _context _context.modelMeta and _context.model should not be nil.</div><div class="line"> */</div><div class="line">static void ModelSetWithDictionaryFunction(const void *_key, const void *_value, void *_context) &#123;</div><div class="line">    ModelSetContext *context = _context;</div><div class="line">    __unsafe_unretained _YYModelMeta *meta = (__bridge _YYModelMeta *)(context-&gt;modelMeta);</div><div class="line">    __unsafe_unretained _YYModelPropertyMeta *propertyMeta = [meta-&gt;_mapper objectForKey:(__bridge id)(_key)];</div><div class="line">    __unsafe_unretained id model = (__bridge id)(context-&gt;model);</div><div class="line">    while (propertyMeta) &#123;</div><div class="line">        if (propertyMeta-&gt;_setter) &#123;</div><div class="line">            ModelSetValueForProperty(model, (__bridge __unsafe_unretained id)_value, propertyMeta);</div><div class="line">        &#125;</div><div class="line">        propertyMeta = propertyMeta-&gt;_next;</div><div class="line">    &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>自定义的<code>CFArrayApplyFunction</code> 的回调方法，CoreFoundation中的原回调函数<br><code>typedef void (*CFArrayApplierFunction)(const void *value, void *context);</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> Apply function for model property meta, to set dictionary to model.</div><div class="line"> </div><div class="line"> @param _propertyMeta should not be nil, _YYModelPropertyMeta.</div><div class="line"> @param _context      _context.model and _context.dictionary should not be nil.</div><div class="line"> */</div><div class="line">static void ModelSetWithPropertyMetaArrayFunction(const void *_propertyMeta, void *_context) &#123;</div><div class="line">    ModelSetContext *context = _context;</div><div class="line">    __unsafe_unretained NSDictionary *dictionary = (__bridge NSDictionary *)(context-&gt;dictionary);</div><div class="line">    __unsafe_unretained _YYModelPropertyMeta *propertyMeta = (__bridge _YYModelPropertyMeta *)(_propertyMeta);</div><div class="line">    if (!propertyMeta-&gt;_setter) return;</div><div class="line">    id value = nil;</div><div class="line">    </div><div class="line">    if (propertyMeta-&gt;_mappedToKeyArray) &#123;</div><div class="line">            //从dic中获取映射多个key的值,返回映射到的第一个值</div><div class="line">        value = YYValueForMultiKeys(dictionary, propertyMeta-&gt;_mappedToKeyArray);</div><div class="line">    &#125; else if (propertyMeta-&gt;_mappedToKeyPath) &#123;</div><div class="line">            //从dic中获取映射keypath的值</div><div class="line">        value = YYValueForKeyPath(dictionary, propertyMeta-&gt;_mappedToKeyPath);</div><div class="line">    &#125; else &#123;</div><div class="line">            //从dic中获取映射key的值</div><div class="line">        value = [dictionary objectForKey:propertyMeta-&gt;_mappedToKey];</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    if (value) &#123;</div><div class="line">            //Model 属性赋值</div><div class="line">        __unsafe_unretained id model = (__bridge id)(context-&gt;model);</div><div class="line">        ModelSetValueForProperty(model, value, propertyMeta);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>最终实现model 属性赋值。 该方法比较长，首先对 meta的属性类型进行判断，主要分为三类，</p>
<ul>
<li>C基本数据类型</li>
<li>Foundation 类型</li>
<li>其他类型，如 id， Class ，block，SEL等等<br>根据类型获取对应value，</li>
</ul>
<p>最后都调用 <code>((void (*)(id, SEL, id))(void *) objc_msgSend)((id)model, meta-&gt;_setter, (id)value)</code> 进行model 属性赋值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">static void ModelSetValueForProperty(__unsafe_unretained id model,</div><div class="line">                                     __unsafe_unretained id value,</div><div class="line">                                     __unsafe_unretained _YYModelPropertyMeta *meta)</div></pre></td></tr></table></figure>
<h3 id="Model-转-JSON"><a href="#Model-转-JSON" class="headerlink" title="Model 转 JSON"></a>Model 转 JSON</h3><p>其中有效的JSON Object 只能是以下类型：<br>NSArray，NSDictionary，NSString，NSNumber，NSNull。</p>
<blockquote>
<p>1.如果是NSDictionary,NSSet,NSArray 类型，递归调用此方法获得JSON Object<br>2.如果是NSURL，NSAttributedString ，NSDate， NSData，做简单相应返回<br>3.根据Model类型创建modelMeta，取实例变量<code>_mapper</code> 获取所有属性名和｀<code>propertyMeta</code>,再根据<code>propertyMeta</code>的 类型<code>_type</code> 获得相应的 <code>value</code>, 根据有无<code>_mappedToKeyPath</code>再进一步处理，赋值，最后 判断有无自定义<code>_hasCustomTransformToDictionary</code>，返回最终转化结果</p>
</blockquote>
<p>主要方法：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div></pre></td><td class="code"><pre><div class="line">static id ModelToJSONObjectRecursive(NSObject *model) &#123;</div><div class="line">  </div><div class="line">    if (!model || model == (id)kCFNull) return model;</div><div class="line">    if ([model isKindOfClass:[NSString class]]) return model;</div><div class="line">    if ([model isKindOfClass:[NSNumber class]]) return model;</div><div class="line">    if ([model isKindOfClass:[NSDictionary class]]) &#123;</div><div class="line">        if ([NSJSONSerialization isValidJSONObject:model]) return model;</div><div class="line">        NSMutableDictionary *newDic = [NSMutableDictionary new];</div><div class="line">        [((NSDictionary *)model) enumerateKeysAndObjectsUsingBlock:^(NSString *key, id obj, BOOL *stop) &#123;</div><div class="line">            NSString *stringKey = [key isKindOfClass:[NSString class]] ? key : key.description;</div><div class="line">            if (!stringKey) return;</div><div class="line">            id jsonObj = ModelToJSONObjectRecursive(obj);</div><div class="line">            if (!jsonObj) jsonObj = (id)kCFNull;</div><div class="line">            newDic[stringKey] = jsonObj;</div><div class="line">        &#125;];</div><div class="line">        return newDic;</div><div class="line">    &#125;</div><div class="line">    if ([model isKindOfClass:[NSSet class]]) &#123;</div><div class="line">        NSArray *array = ((NSSet *)model).allObjects;</div><div class="line">        if ([NSJSONSerialization isValidJSONObject:array]) return array;</div><div class="line">        NSMutableArray *newArray = [NSMutableArray new];</div><div class="line">        for (id obj in array) &#123;</div><div class="line">            if ([obj isKindOfClass:[NSString class]] || [obj isKindOfClass:[NSNumber class]]) &#123;</div><div class="line">                [newArray addObject:obj];</div><div class="line">            &#125; else &#123;</div><div class="line">                id jsonObj = ModelToJSONObjectRecursive(obj);</div><div class="line">                if (jsonObj &amp;&amp; jsonObj != (id)kCFNull) [newArray addObject:jsonObj];</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        return newArray;</div><div class="line">    &#125;</div><div class="line">    if ([model isKindOfClass:[NSArray class]]) &#123;</div><div class="line">        if ([NSJSONSerialization isValidJSONObject:model]) return model;</div><div class="line">        NSMutableArray *newArray = [NSMutableArray new];</div><div class="line">        for (id obj in (NSArray *)model) &#123;</div><div class="line">            if ([obj isKindOfClass:[NSString class]] || [obj isKindOfClass:[NSNumber class]]) &#123;</div><div class="line">                [newArray addObject:obj];</div><div class="line">            &#125; else &#123;</div><div class="line">                id jsonObj = ModelToJSONObjectRecursive(obj);</div><div class="line">                if (jsonObj &amp;&amp; jsonObj != (id)kCFNull) [newArray addObject:jsonObj];</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        return newArray;</div><div class="line">    &#125;</div><div class="line">    if ([model isKindOfClass:[NSURL class]]) return ((NSURL *)model).absoluteString;</div><div class="line">    if ([model isKindOfClass:[NSAttributedString class]]) return ((NSAttributedString *)model).string;</div><div class="line">    if ([model isKindOfClass:[NSDate class]]) return [YYISODateFormatter() stringFromDate:(id)model];</div><div class="line">    if ([model isKindOfClass:[NSData class]]) return nil;</div><div class="line">    </div><div class="line">    _YYModelMeta *modelMeta = [_YYModelMeta metaWithClass:[model class]];</div><div class="line">    if (!modelMeta || modelMeta-&gt;_keyMappedCount == 0) return nil;</div><div class="line">    NSMutableDictionary *result = [[NSMutableDictionary alloc] initWithCapacity:64];</div><div class="line">    __unsafe_unretained NSMutableDictionary *dic = result; // avoid retain and release in block</div><div class="line">    [modelMeta-&gt;_mapper enumerateKeysAndObjectsUsingBlock:^(NSString *propertyMappedKey, _YYModelPropertyMeta *propertyMeta, BOOL *stop) &#123;</div><div class="line">        if (!propertyMeta-&gt;_getter) return;</div><div class="line">        </div><div class="line">        id value = nil;</div><div class="line">        if (propertyMeta-&gt;_isCNumber) &#123;</div><div class="line">            value = ModelCreateNumberFromProperty(model, propertyMeta);</div><div class="line">        &#125; else if (propertyMeta-&gt;_nsType) &#123;</div><div class="line">            id v = ((id (*)(id, SEL))(void *) objc_msgSend)((id)model, propertyMeta-&gt;_getter);</div><div class="line">            value = ModelToJSONObjectRecursive(v);</div><div class="line">        &#125; else &#123;</div><div class="line">            switch (propertyMeta-&gt;_type &amp; YYEncodingTypeMask) &#123;</div><div class="line">                case YYEncodingTypeObject: &#123;</div><div class="line">                    id v = ((id (*)(id, SEL))(void *) objc_msgSend)((id)model, propertyMeta-&gt;_getter);</div><div class="line">                    value = ModelToJSONObjectRecursive(v);</div><div class="line">                    if (value == (id)kCFNull) value = nil;</div><div class="line">                &#125; break;</div><div class="line">                case YYEncodingTypeClass: &#123;</div><div class="line">                    Class v = ((Class (*)(id, SEL))(void *) objc_msgSend)((id)model, propertyMeta-&gt;_getter);</div><div class="line">                    value = v ? NSStringFromClass(v) : nil;</div><div class="line">                &#125; break;</div><div class="line">                case YYEncodingTypeSEL: &#123;</div><div class="line">                    SEL v = ((SEL (*)(id, SEL))(void *) objc_msgSend)((id)model, propertyMeta-&gt;_getter);</div><div class="line">                    value = v ? NSStringFromSelector(v) : nil;</div><div class="line">                &#125; break;</div><div class="line">                default: break;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        if (!value) return;</div><div class="line">        </div><div class="line">        if (propertyMeta-&gt;_mappedToKeyPath) &#123;</div><div class="line">            NSMutableDictionary *superDic = dic;</div><div class="line">            NSMutableDictionary *subDic = nil;</div><div class="line">            for (NSUInteger i = 0, max = propertyMeta-&gt;_mappedToKeyPath.count; i &lt; max; i++) &#123;</div><div class="line">                NSString *key = propertyMeta-&gt;_mappedToKeyPath[i];</div><div class="line">                if (i + 1 == max) &#123; // end</div><div class="line">                    if (!superDic[key]) superDic[key] = value;</div><div class="line">                    break;</div><div class="line">                &#125;</div><div class="line">                </div><div class="line">                subDic = superDic[key];</div><div class="line">                if (subDic) &#123;</div><div class="line">                    if ([subDic isKindOfClass:[NSDictionary class]]) &#123;</div><div class="line">                        subDic = subDic.mutableCopy;</div><div class="line">                        superDic[key] = subDic;</div><div class="line">                    &#125; else &#123;</div><div class="line">                        break;</div><div class="line">                    &#125;</div><div class="line">                &#125; else &#123;</div><div class="line">                    subDic = [NSMutableDictionary new];</div><div class="line">                    superDic[key] = subDic;</div><div class="line">                &#125;</div><div class="line">                superDic = subDic;</div><div class="line">                subDic = nil;</div><div class="line">            &#125;</div><div class="line">        &#125; else &#123;</div><div class="line">            if (!dic[propertyMeta-&gt;_mappedToKey]) &#123;</div><div class="line">                dic[propertyMeta-&gt;_mappedToKey] = value;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;];</div><div class="line">    </div><div class="line">    if (modelMeta-&gt;_hasCustomTransformToDictionary) &#123;</div><div class="line">        BOOL suc = [((id&lt;YYModel&gt;)model) modelCustomTransformToDictionary:dic];</div><div class="line">        if (!suc) return nil;</div><div class="line">    &#125;</div><div class="line">    return result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="http://www.jianshu.com/users/aa41dad549af/latest_articles" target="_blank" rel="external">郑钦洪_：YYModel 源码历险记</a></p>

      
    </div>
    
  </div>
  
    
    <div class="copyright">
        <p><span>本文標題:</span><a href="/2017/01/03/YYModel/">YYModel源码分析</a></p>
        <p><span>文章作者:</span><a href="/" title="回到主頁">Chen Ao</a></p>
        <p><span>發布時間:</span>2017-01-03, 09:43:35</p>
        <p><span>最後更新:</span>2017-01-04, 15:23:41</p>
        <p>
            <span>原始鏈接:</span><a class="post-url" href="/2017/01/03/YYModel/" title="YYModel源码分析">http://ChenAo0727.github.io/2017/01/03/YYModel/</a>
            <span class="copy-path" data-clipboard-text="原文: http://ChenAo0727.github.io/2017/01/03/YYModel/　　作者: Chen Ao" title="點擊複製文章鏈接"><i class="fa fa-clipboard"></i></span>
            <script> var clipboard = new Clipboard('.copy-path'); </script>
        </p>
        <p>
            <span>許可協議:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" title="CC BY-NC-SA 4.0 International" target = "_blank">"姓名標示-非商業性-相同方式分享 4.0 國際"</a> 轉載請保留原文鏈接及作者。
        </p>
    </div>



    <nav id="article-nav">
        
        
            <div id="article-nav-older" class="article-nav-title">
                <a href="/2016/12/28/hexo/">
                    Hexo + Github-Pages 从零开始搭建个人博客
                </a>
            </div>
        
    </nav>

  
</article>

    <div id="toc" class="toc-article">
        <strong class="toc-title">文章目錄</strong>
        
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#YYClassInfo"><span class="toc-number">2.</span> <span class="toc-text">YYClassInfo</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#要点"><span class="toc-number">2.1.</span> <span class="toc-text">要点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#变量类型编码"><span class="toc-number">2.2.</span> <span class="toc-text">变量类型编码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#YYEncodingType"><span class="toc-number">2.3.</span> <span class="toc-text">YYEncodingType</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Var-Method-Property"><span class="toc-number">2.4.</span> <span class="toc-text">Var Method Property</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#元类"><span class="toc-number">2.5.</span> <span class="toc-text">元类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#初始化方法"><span class="toc-number">2.6.</span> <span class="toc-text">初始化方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#NSObject-YYModel"><span class="toc-number">3.</span> <span class="toc-text">NSObject+YYModel:</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#私有类-YYModelPropertyMeta"><span class="toc-number">3.1.</span> <span class="toc-text">私有类_YYModelPropertyMeta</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#内部实例变量"><span class="toc-number">3.1.1.</span> <span class="toc-text">内部实例变量</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#初始化方法-1"><span class="toc-number">3.1.2.</span> <span class="toc-text">初始化方法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#私有类-YYModelMeta"><span class="toc-number">3.2.</span> <span class="toc-text">私有类_YYModelMeta</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#内部变量"><span class="toc-number">3.2.1.</span> <span class="toc-text">内部变量</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#初始化"><span class="toc-number">3.2.2.</span> <span class="toc-text">初始化</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JSON-转-Model"><span class="toc-number">3.3.</span> <span class="toc-text">JSON 转 Model</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Model-转-JSON"><span class="toc-number">3.4.</span> <span class="toc-text">Model 转 JSON</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考资料"><span class="toc-number">4.</span> <span class="toc-text">参考资料</span></a></li></ol>
        
    </div>
    <style>
        .left-col .switch-btn,
        .left-col .switch-area {
            display: none;
        }
        .toc-level-3 i,
        .toc-level-3 ol {
            display: none !important;
        }
    </style>

    <input type="button" id="tocButton" value="隱藏目錄"  title="點擊按鈕隱藏或者顯示文章目錄">

    <script>
        yiliaConfig.toc = ["隱藏目錄", "顯示目錄", !!"false"];
    </script>



    
<div class="share">
    
        <div class="bdsharebuttonbox">
            <a href="#" class="fa fa-twitter bds_twi" data-cmd="twi" title="分享到推特"></a>
            <a href="#" class="fa fa-weibo bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
            <a href="#" class="fa fa-qq bds_sqq" data-cmd="sqq" title="分享给 QQ 好友"></a>
            <a href="#" class="fa fa-files-o bds_copy" data-cmd="copy" title="复制网址"></a>
            <a href="#" class="fa fa fa-envelope-o bds_mail" data-cmd="mail" title="通过邮件分享"></a>
            <a href="#" class="fa fa-weixin bds_weixin" data-cmd="weixin" title="生成文章二维码"></a>
            <a href="#" class="fa fa-share-alt bds_more" data-cmd="more"></i></a>
        </div>
        <script>
            window._bd_share_config={
                "common":{"bdSnsKey":{},"bdText":"YYModel源码分析　| 夜空中最亮的星　","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
        </script>
    

    
</div>







    
      <div class="duoshuo" id="comments">
    <div id="comment-box" ></div>
    <div class="ds-thread" id="ds-thread" data-thread-key="2017/01/03/YYModel/" data-title="YYModel源码分析" data-url="http://ChenAo0727.github.io/2017/01/03/YYModel/"></div>
    <script>
        var duoshuoQuery = {short_name:"chenao0727github"};
        var loadComment = function(){
            var d = document, s = d.createElement('script');
            s.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
            s.async = true; s.charset = 'UTF-8';
            (d.head || d.body).appendChild(s);
        }

        
    </script>
    
    <script> loadComment(); </script>

</div>
    




    <div class="scroll" id="post-nav-button">
        
            <a href="/" title="回到主頁"><i class="fa fa-home"></i></a>
        

        <a title="文章列表"><i class="fa fa-bars"></i><i class="fa fa-times"></i></a>

        
            <a href="/2016/12/28/hexo/" title="下一篇: Hexo + Github-Pages 从零开始搭建个人博客">
                <i class="fa fa-angle-right"></i>
            </a>
        
    </div>

    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/01/03/YYModel/">YYModel源码分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/28/hexo/">Hexo + Github-Pages 从零开始搭建个人博客</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/27/Swift-closure/">Swift 闭包</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/26/Kingfisher/">Kingfisher 3.x 学习（一）</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/26/Kingfisher2/">Kingfisher 3.x 学习（二）</a></li></ul>




    <script>
        
    </script>
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                <i class="fa fa-copyright"></i> 
                2016-2017 Chen Ao
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank" title="快速、簡潔且高效的博客框架">Hexo</a>  Theme <a href="https://github.com/MOxFIVE/hexo-theme-yelee" target="_blank" title="簡而不減 Hexo 雙欄博客主題  v3.5">Yelee</a> by MOxFIVE <i class="fa fa-heart animated infinite pulse"></i>
            </div>
        </div>
        
            <div class="visit">
                
                    <span id="busuanzi_container_site_pv" style='display:none'>
                        <span id="site-visit" title="本站到訪數"><i class="fa fa-user" aria-hidden="true"></i><span id="busuanzi_value_site_uv"></span>
                        </span>
                    </span>
                
                
                    <span>| </span>
                
                
                    <span id="busuanzi_container_page_pv" style='display:none'>
                        <span id="page-visit"  title="本頁閱讀量"><i class="fa fa-eye animated infinite pulse" aria-hidden="true"></i><span id="busuanzi_value_page_pv"></span>
                        </span>
                    </span>
                
            </div>
        
    </div>
</footer>
    </div>
    
<script data-main="/js/main.js" src="//cdn.bootcss.com/require.js/2.2.0/require.min.js"></script>

    <script>
        $(document).ready(function() {
            var iPad = window.navigator.userAgent.indexOf('iPad');
            if (iPad > -1 || $(".left-col").css("display") === "none") {
                var bgColorList = ["#9db3f4", "#414141", "#e5a859", "#f5dfc6", "#c084a0", "#847e72", "#cd8390", "#996731"];
                var bgColor = Math.ceil(Math.random() * (bgColorList.length - 1));
                $("body").css({"background-color": bgColorList[bgColor], "background-size": "cover"});
            }
            else {
                var backgroundnum = 5;
                var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
                $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
            }
        })
    </script>





<div class="scroll" id="scroll">
    <a href="#" title="返回頂部"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" onclick="load$hide();" title="查看評論"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="轉到底部"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    // Open in New Window
    
        var oOpenInNew = {
            
            
            
            
            
            
             archives: ".archive-article-title", 
             miniArchives: "a.post-list-link", 
            
             friends: "#js-friends a", 
             socail: ".social a" 
        }
        for (var x in oOpenInNew) {
            $(oOpenInNew[x]).attr("target", "_blank");
        }
    
</script>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  </div>
</body>
</html>